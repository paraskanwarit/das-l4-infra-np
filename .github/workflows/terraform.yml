name: Terraform Apply

on:
  push:
    branches: [ "main" ]
    paths:
      - 'environments/non-prod/**'

jobs:
  apply:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to detect changes
      
      - name: Check if files were deleted
        id: check-deletions
        run: |
          # Check if any environment directories were deleted
          DELETED_ENVS=$(git diff --name-only --diff-filter=D HEAD~1 HEAD | grep "^environments/non-prod/" | grep -E "/[^/]+/$" | sed 's|environments/non-prod/||' | sed 's|/$||' || echo "")
          if [ -n "$DELETED_ENVS" ]; then
            echo "deleted=true" >> $GITHUB_OUTPUT
            echo "Found deleted environments: $DELETED_ENVS"
          else
            echo "deleted=false" >> $GITHUB_OUTPUT
            echo "No environments were deleted"
          fi

      - name: Set up Terraform
        if: steps.check-deletions.outputs.deleted == 'false'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.2

      - name: Google Auth
        if: steps.check-deletions.outputs.deleted == 'false'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/566479143581/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
          service_account: 'github-actions-sa@affable-beaker-464822-b4.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        if: steps.check-deletions.outputs.deleted == 'false'
        uses: google-github-actions/setup-gcloud@v2

      - name: Clean State Locks
        if: steps.check-deletions.outputs.deleted == 'false'
        run: |
          # Clean up any stale state locks
          gsutil rm gs://terraform-statefile-p/*/terraform/state/default.tflock 2>/dev/null || echo "No locks to clean"

      - name: Deploy Environments
        if: steps.check-deletions.outputs.deleted == 'false'
        run: |
          # Get all environments to deploy
          ENVIRONMENTS=$(find environments/non-prod -maxdepth 1 -type d -name "*" | grep -v "^environments/non-prod$" | xargs -I {} sh -c 'if [ -f "{}/main.tf" ]; then basename "{}"; fi' | sort)
          echo "Auto-detected environments: $ENVIRONMENTS"
          
          # Deploy each environment sequentially to avoid state lock conflicts
          for ENV in $ENVIRONMENTS; do
            echo "ðŸš€ Deploying $ENV environment..."
            
            ENV_PATH="environments/non-prod/$ENV"
            INSTANCE_NAME="${ENV}-sql-instance"
            
            # Generate passwords
            ROOT_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-32)
            APP_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-32)
            
            # Terraform commands with lock handling
            terraform -chdir=$ENV_PATH init -lock=false
            terraform -chdir=$ENV_PATH import module.cloudsql.google_sql_database_instance.primary projects/affable-beaker-464822-b4/instances/$INSTANCE_NAME || echo "Instance does not exist or already imported"
            terraform -chdir=$ENV_PATH plan -lock=false -var="sql_root_password=$ROOT_PASSWORD" -var="sql_app_password=$APP_PASSWORD"
            terraform -chdir=$ENV_PATH apply -auto-approve -lock=false -var="sql_root_password=$ROOT_PASSWORD" -var="sql_app_password=$APP_PASSWORD"
            
            # Store passwords
            echo "$ROOT_PASSWORD" | gcloud secrets create cloudsql-root-password-$ENV --data-file=- --replication-policy="automatic" || echo "Secret already exists"
            echo "$APP_PASSWORD" | gcloud secrets create cloudsql-app-password-$ENV --data-file=- --replication-policy="automatic" || echo "Secret already exists"
            
            echo "âœ… $ENV deployed successfully"
          done

      - name: Skip Apply (Files Deleted)
        if: steps.check-deletions.outputs.deleted == 'true'
        run: |
          echo "ðŸ”„ Skipping apply workflow - environment files were deleted"
          echo "Destroy workflow will handle the cleanup"
